{% extends "base.html" %}

{% block title %}{{ session.name }} - é¢è¯•ä¼šè¯{% endblock %}

{% block extra_css %}
<style>
    .candidate-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .interview-container {
        height: calc(100vh - 200px);
        display: flex;
        gap: 1rem;
    }
    
    .sidebar {
        width: 350px;
        max-height: 100%;
        overflow-y: auto;
    }
    
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    @media (max-width: 992px) {
        .interview-container {
            flex-direction: column;
            height: auto;
        }

        .sidebar {
            width: 100%;
            max-height: 300px;
        }

        .chat-area {
            height: calc(100vh - 350px);
        }
    }

    /* æŠ¥å‘ŠæŒ‰é’®æ ·å¼ */
    .round-report-actions {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 12px;
        margin-top: 15px;
    }

    .round-report-actions .btn {
        border-radius: 6px;
        font-size: 0.85rem;
        padding: 0.375rem 0.75rem;
    }

    .round-report-actions .btn:hover {
        transform: translateY(-1px);
        transition: transform 0.2s ease;
    }

    /* æŠ¥å‘ŠçŠ¶æ€æŒ‡ç¤ºå™¨ */
    .report-status {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.8rem;
    }

    .status-indicator {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
    }

    .status-pending { background-color: #ffc107; }
    .status-completed { background-color: #28a745; }
    .status-error { background-color: #dc3545; }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- é¢åŒ…å±‘å¯¼èˆª -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('room.index') }}">
                        <i class="fas fa-home me-1"></i>é¦–é¡µ
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{{ url_for('room.room_detail', room_id=session.room_id) }}">
                        <i class="fas fa-door-open me-1"></i>é¢è¯•é—´
                    </a>
                </li>
                <li class="breadcrumb-item active">
                    <i class="fas fa-comments me-1"></i>{{ session.name }}
                </li>
            </ol>
        </nav>
        
        <!-- ä¸»è¦é¢è¯•ç•Œé¢ -->
        <div class="interview-container">
            <!-- å·¦ä¾§è¾¹æ ï¼šå€™é€‰äººä¿¡æ¯å’Œç®€å† -->
            <div class="sidebar">
                {% if resume %}
                <!-- å€™é€‰äººåŸºæœ¬ä¿¡æ¯ -->
                <div class="candidate-info">
                    <div class="text-center mb-3">
                        <div class="candidate-avatar mb-2">
                            <i class="fas fa-user-circle fa-3x"></i>
                        </div>
                        <h5 class="mb-1">{{ resume.name }}</h5>
                        {% if has_custom_jd %}
                        <p class="mb-0 opacity-75">
                            <i class="fas fa-file-alt me-1"></i>è‡ªå®šä¹‰èŒä½è¦æ±‚
                        </p>
                        {% else %}
                        <p class="mb-0 opacity-75">{{ resume.position }}</p>
                        {% endif %}
                    </div>
                    
                    <div class="candidate-stats">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end border-light border-opacity-50">
                                    <h6 class="mb-0">{{ resume.skills|length }}</h6>
                                    <small class="opacity-75">æŠ€èƒ½é¡¹ç›®</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <h6 class="mb-0">{{ resume.projects|length }}</h6>
                                <small class="opacity-75">é¡¹ç›®ç»éªŒ</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æŠ€èƒ½åˆ—è¡¨ -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>æŠ€èƒ½æ ˆ
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="skill-tags">
                            {% for skill in resume.skills %}
                            <div class="skill-item mb-2 p-2 border rounded">
                                <small class="text-muted">{{ loop.index }}.</small>
                                <span class="ms-1" style="font-size: 0.85rem;">{{ skill[:80] }}{% if skill|length > 80 %}...{% endif %}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- é¡¹ç›®ç»éªŒ -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>é¡¹ç›®ç»éªŒ
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        {% for project in resume.projects %}
                        <div class="project-item mb-2 p-2 border rounded">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-code text-primary me-2 mt-1"></i>
                                <div class="flex-grow-1">
                                    <small class="text-muted">é¡¹ç›® {{ loop.index }}</small>
                                    <div style="font-size: 0.85rem;" class="mt-1">
                                        {{ project[:100] }}{% if project|length > 100 %}...{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- å³ä¾§ï¼šChatGPTé£æ ¼å¯¹è¯ç•Œé¢ -->
            <div class="chat-area">
                <div class="chat-container">
                    <!-- èŠå¤©å¤´éƒ¨ -->
                    <div class="chat-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">{{ session.name }}</h6>
                                <small class="opacity-75">AIæ™ºèƒ½é¢è¯•å®˜</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-light" onclick="generateQuestions()">
                                    <i class="fas fa-plus me-1"></i>ç”Ÿæˆé¢è¯•é¢˜
                                </button>
                                <!-- æŠ¥å‘ŠæŒ‰é’®åŒºåŸŸ -->
                                <div id="reportButtonsContainer"></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ¶ˆæ¯åŒºåŸŸ -->
                    <div class="chat-messages" id="chatMessages">
                        <!-- æ¬¢è¿æ¶ˆæ¯ -->
                        <div class="message ai">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div>æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIé¢è¯•å®˜ã€‚æˆ‘å·²ç»æŸ¥çœ‹äº†æ‚¨çš„ç®€å†ï¼Œå‡†å¤‡å¼€å§‹é¢è¯•ã€‚</div>
                                <div class="message-time">{{ session.created_at[:19]|replace('T', ' ') }}</div>
                            </div>
                        </div>
                        
                        <!-- åŠ¨æ€åŠ è½½çš„å¯¹è¯è½®æ¬¡ -->
                        {% for round in rounds %}
                        <div class="round-header" data-round-id="{{ round.id }}">
                            <span>ç¬¬{{ round.round_index + 1 }}è½®é¢è¯•é¢˜</span>
                        </div>

                        <!-- AIç”Ÿæˆçš„é—®é¢˜ -->
                        <div class="message ai">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                {% if round.status == 'completed' %}
                                    <!-- å·²å®Œæˆçš„è½®æ¬¡ï¼šæ˜¾ç¤ºæ‰€æœ‰é—®é¢˜ -->
                                    <div>æˆ‘ä¸ºæ‚¨å‡†å¤‡äº†ä»¥ä¸‹{{ round.questions|length }}é“é¢è¯•é¢˜ï¼š</div>
                                    <div class="questions-container mt-3">
                                        {% for question in round.questions %}
                                        <div class="question-card mb-2">
                                            <div class="question-text">
                                                <span class="question-number">{{ loop.index }}.</span>
                                                {{ question }}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <!-- è¿›è¡Œä¸­çš„è½®æ¬¡ï¼šä¸æ˜¾ç¤ºé—®é¢˜åˆ—è¡¨ -->
                                    <div>æˆ‘ä¸ºæ‚¨å‡†å¤‡äº†{{ round.questions|length }}é“é¢è¯•é¢˜ã€‚è®©æˆ‘ä»¬é€ä¸€è¿›è¡Œï¼Œè¯·ä»”ç»†å›ç­”æ¯ä¸€é“é¢˜ç›®ã€‚</div>
                                {% endif %}
                                <div class="message-time">{{ round.created_at[:19]|replace('T', ' ') }}</div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                        <div class="typing-indicator" id="typingIndicator" style="display: none;">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div>
                                AIæ­£åœ¨ç”Ÿæˆé¢è¯•é¢˜
                                <div class="typing-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="chat-input">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   placeholder="æ‚¨å¯ä»¥å›ç­”é¢è¯•é¢˜æˆ–è¯·æ±‚ç”Ÿæˆæ–°çš„é¢˜ç›®..." 
                                   id="messageInput"
                                   onkeypress="handleKeyPress(event)">
                            <button class="btn btn-primary" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        
                        <div class="mt-2 text-center">
                            <small class="text-muted">
                                æŒ‰å›è½¦å‘é€æ¶ˆæ¯ | 
                                <a href="javascript:generateQuestions()" class="text-decoration-none">ç‚¹å‡»ç”Ÿæˆæ–°çš„é¢è¯•é¢˜</a>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ç”±åç«¯æ³¨å…¥ï¼šæ•°å­—äººå¯åŠ¨æç¤ºä¸é“¾æ¥ï¼ˆå¯èƒ½ä¸º nullï¼‰
const DH_BOOT_MESSAGE = {{ dh_message|tojson|safe if dh_message else 'null' }};
const DH_CONNECT_URL = {{ dh_connect_url|tojson|safe if dh_connect_url else 'null' }};

// å…¨å±€ä¼šè¯IDã€æˆ¿é—´IDå’Œå½“å‰è½®æ¬¡çŠ¶æ€
const SESSION_ID = '{{ session.id }}';
const ROOM_ID = '{{ session.room_id }}';
let currentRoundId = null;
let currentQuestionData = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
$(document).ready(async function() {
    scrollToBottom();
    console.log('é¢è¯•ä¼šè¯é¡µé¢å·²åŠ è½½');

    // å¦‚æœæœ‰æ•°å­—äººæç¤ºåˆ™æ˜¾ç¤º
    if (DH_BOOT_MESSAGE) {
        addMessage('ai', DH_BOOT_MESSAGE);
    }

    // æ£€æŸ¥æ˜¯å¦æœ‰è¿›è¡Œä¸­çš„è½®æ¬¡
    await checkActiveRound();

    // æ£€æŸ¥å·²æœ‰æŠ¥å‘ŠçŠ¶æ€
    await checkExistingReports();

    // === æ­£å¼ä¿®å¤ï¼šé¡µé¢åŠ è½½å®Œæˆåï¼Œè‡ªåŠ¨è¯†åˆ«æœ€åä¸€è½®å¹¶æ˜¾ç¤ºã€ç”ŸæˆæŠ¥å‘Šã€‘æŒ‰é’® ===
    const headers = document.querySelectorAll('.round-header');
    if (headers.length) {
        currentRoundId = headers[headers.length - 1].dataset.roundId;
        showReportButtons();
    }
});

// æ£€æŸ¥æ˜¯å¦æœ‰è¿›è¡Œä¸­çš„è½®æ¬¡
async function checkActiveRound() {
    // æŸ¥æ‰¾é¡µé¢ä¸­çš„æœ€åä¸€ä¸ªè½®æ¬¡
    const rounds = document.querySelectorAll('.round-header');
    if (rounds.length > 0) {
        // ä»æœ€åä¸€ä¸ªè½®æ¬¡headeræå–round_id
        const lastRound = rounds[rounds.length - 1];
        const roundData = lastRound.dataset.roundId;
        if (roundData) {
            currentRoundId = roundData;
            // å°è¯•åŠ è½½å½“å‰é—®é¢˜
            await loadCurrentQuestion();
        }
    }
}

// æ»šåŠ¨åˆ°æ¶ˆæ¯åº•éƒ¨
function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// å¤„ç†é”®ç›˜æŒ‰é”®
function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// å‘é€æ¶ˆæ¯ï¼ˆå¤„ç†ç”¨æˆ·å›ç­”ï¼‰
function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (message && currentQuestionData) {
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        addMessage('user', message);
        input.value = '';

        // ä¿å­˜å›ç­”åˆ°åç«¯
        saveAnswer(currentQuestionData.qa_id, message);
    } else if (message && !currentQuestionData) {
        // æ²¡æœ‰å½“å‰é—®é¢˜æ—¶çš„æ™®é€šèŠå¤©
        addMessage('user', message);
        input.value = '';

        // æ¨¡æ‹ŸAIå›å¤
        setTimeout(() => {
            addMessage('ai', 'æ„Ÿè°¢æ‚¨çš„å›ç­”ã€‚å¦‚æœæ‚¨å‡†å¤‡å¥½äº†ï¼Œå¯ä»¥ç‚¹å‡»"ç”Ÿæˆé¢è¯•é¢˜"å¼€å§‹é¢è¯•ã€‚');
        }, 1000);
    }
}

// æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
function addMessage(type, content) {
    const chatMessages = document.getElementById('chatMessages');
    const messageTime = new Date().toLocaleString('zh-CN');
    
    const messageHTML = `
        <div class="message ${type}">
            <div class="message-avatar">
                <i class="fas fa-${type === 'user' ? 'user' : 'robot'}"></i>
            </div>
            <div class="message-content">
                <div>${content}</div>
                <div class="message-time">${messageTime}</div>
            </div>
        </div>
    `;
    
    chatMessages.insertAdjacentHTML('beforeend', messageHTML);
    scrollToBottom();
}

// ç”Ÿæˆé¢è¯•é¢˜
async function generateQuestions() {
    const headerButton = document.querySelector('.chat-header button');
    let originalContent = '';
    if (headerButton) {
        originalContent = headerButton.innerHTML;
    }

    try {
        // å…ˆæ£€æŸ¥æ˜¯å¦æœ‰ç®€å†æ•°æ®
        const resumeCheckResponse = await fetch(`/api/resume/${ROOM_ID}`);
        const resumeCheck = await resumeCheckResponse.json();

        if (!resumeCheck.success || !resumeCheck.data || !resumeCheck.data.resume) {
            YeyingInterviewer.showToast('warning', 'è¯·å…ˆä¸Šä¼ ç®€å†ï¼');
            addMessage('ai', 'æŠ±æ­‰ï¼Œç³»ç»Ÿä¸­è¿˜æ²¡æœ‰ç®€å†æ•°æ®ã€‚è¯·å…ˆå‰å¾€<a href="/" style="color: #007bff; text-decoration: underline;">é¦–é¡µ</a>ä¸Šä¼ ç®€å†ï¼Œç„¶åå†ç”Ÿæˆé¢è¯•é¢˜ã€‚');
            return;
        }

        if (headerButton) {
            headerButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ç”Ÿæˆä¸­...';
            headerButton.disabled = true;
        }
        document.getElementById('typingIndicator').style.display = 'flex';
        scrollToBottom();

        const response = await fetch(`/generate_questions/${SESSION_ID}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        document.getElementById('typingIndicator').style.display = 'none';

        if (data.success && data.data) {
            // è§£æ„åµŒå¥—çš„æ•°æ®
            const result = data.data;
            currentRoundId = result.round_id;

            const roundHeader = `
                <div class="round-header" data-round-id="${result.round_id}">
                    <span>ç¬¬${result.round_index + 1}è½®é¢è¯•é¢˜</span>
                </div>
            `;
            document.getElementById('chatMessages').insertAdjacentHTML('beforeend', roundHeader);

            addMessage('ai', `å¥½çš„ï¼æˆ‘ä¸ºæ‚¨å‡†å¤‡äº†${result.questions.length}é“é¢è¯•é¢˜ã€‚è®©æˆ‘ä»¬é€ä¸€è¿›è¡Œï¼Œè¯·ä»”ç»†å›ç­”æ¯ä¸€é“é¢˜ç›®ã€‚`);
            YeyingInterviewer.showToast('success', `æˆåŠŸç”Ÿæˆ${result.questions.length}é“é¢è¯•é¢˜`);

            await loadCurrentQuestion();
        } else {
            YeyingInterviewer.showToast('error', data.error || data.message || 'ç”Ÿæˆé¢è¯•é¢˜å¤±è´¥');
        }

    } catch (error) {
        console.error('ç”Ÿæˆé¢è¯•é¢˜å¤±è´¥:', error);
        YeyingInterviewer.showToast('error', 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
        document.getElementById('typingIndicator').style.display = 'none';
    } finally {
        if (headerButton && originalContent) {
            headerButton.innerHTML = originalContent;
            headerButton.disabled = false;
        }
    }
}

// åŠ è½½å½“å‰é—®é¢˜
async function loadCurrentQuestion() {
    if (!currentRoundId) return;

    try {
        const response = await fetch(`/get_current_question/${currentRoundId}`);
        const data = await response.json();

        if (data.success && data.data && data.data.question_data) {
            currentQuestionData = data.data.question_data;

            const questionHTML = `
                <div class="current-question-info mb-2">
                    <small class="text-muted">ã€${data.data.question_data.category}ã€‘é—®é¢˜ ${data.data.question_data.question_number}/${data.data.question_data.total_questions}</small>
                </div>
                <div class="question-text">${data.data.question_data.question}</div>
                <div class="mt-2">
                    <small class="text-info">è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å›ç­”è¿™ä¸ªé—®é¢˜...</small>
                </div>
            `;

            addMessage('ai', questionHTML);

            const input = document.getElementById('messageInput');
            input.placeholder = `è¯·å›ç­”ç¬¬${data.data.question_data.question_number}é¢˜...`;
            input.focus();

        } else {
            currentQuestionData = null;
            addMessage('ai', 'ğŸ‰ æ­å–œï¼æ‚¨å·²ç»å®Œæˆäº†æœ¬è½®æ‰€æœ‰é¢è¯•é¢˜ã€‚æ‚¨å¯ä»¥ç”Ÿæˆæ–°çš„ä¸€è½®é¢è¯•é¢˜ç»§ç»­ç»ƒä¹ ã€‚');

            const input = document.getElementById('messageInput');
            input.placeholder = 'æ‚¨å¯ä»¥å›ç­”é¢è¯•é¢˜æˆ–è¯·æ±‚ç”Ÿæˆæ–°çš„é¢˜ç›®...';
        }

    } catch (error) {
        console.error('åŠ è½½é—®é¢˜å¤±è´¥:', error);
        YeyingInterviewer.showToast('error', 'åŠ è½½é—®é¢˜å¤±è´¥');
    }
}

// ä¿å­˜ç”¨æˆ·å›ç­”
async function saveAnswer(qaId, answerText) {
    try {
        const response = await fetch('/save_answer', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ qa_id: qaId, answer_text: answerText })
        });

        const data = await response.json();

        if (data.success) {
            setTimeout(() => {
                if (data.is_round_completed) {
                    addMessage('ai', 'âœ… å›ç­”å·²ä¿å­˜ï¼ğŸ‰ æ‚¨å·²å®Œæˆæœ¬è½®æ‰€æœ‰é¢è¯•é¢˜ï¼Œè¡¨ç°å‡ºè‰²ï¼');
                    currentQuestionData = null;

                    const input = document.getElementById('messageInput');
                    input.placeholder = 'æ‚¨å¯ä»¥å›ç­”é¢è¯•é¢˜æˆ–è¯·æ±‚ç”Ÿæˆæ–°çš„é¢˜ç›®...';

                    // ğŸ†• åŠ¨æ€æ˜¾ç¤ºæŠ¥å‘Šç”ŸæˆæŒ‰é’®
                    showReportButtons();
                } else {
                    addMessage('ai', `âœ… å›ç­”å·²ä¿å­˜ï¼è¿˜æœ‰ ${data.remaining_questions} é“é¢˜ï¼Œè®©æˆ‘ä»¬ç»§ç»­ä¸‹ä¸€é¢˜ã€‚`);
                    setTimeout(() => loadCurrentQuestion(), 1000);
                }
            }, 500);

        } else {
            YeyingInterviewer.showToast('error', data.error || 'ä¿å­˜å›ç­”å¤±è´¥');
        }

    } catch (error) {
        console.error('ä¿å­˜å›ç­”å¤±è´¥:', error);
        YeyingInterviewer.showToast('error', 'ä¿å­˜å›ç­”å¤±è´¥');
    }
}

// é¡µé¢å¸è½½æ—¶çš„æ¸…ç†
$(window).on('beforeunload', function() {
    console.log('é¢è¯•ä¼šè¯é¡µé¢å³å°†å¸è½½');
});

// ==================== æŠ¥å‘Šç›¸å…³å‡½æ•° ====================

// åŠ¨æ€æ˜¾ç¤ºæŠ¥å‘ŠæŒ‰é’®ï¼ˆå½“ç”¨æˆ·å®Œæˆæ‰€æœ‰é—®é¢˜åè°ƒç”¨ï¼‰
function showReportButtons() {
    console.log('ğŸ” showReportButtons è¢«è°ƒç”¨');
    console.log('currentRoundId:', currentRoundId);

    // è·å–å½“å‰è½®æ¬¡çš„ round_id
    if (!currentRoundId) {
        console.log('âŒ currentRoundId ä¸ºç©ºï¼Œé€€å‡º');
        return;
    }

    // æŸ¥æ‰¾å½“å‰è½®æ¬¡å¯¹åº”çš„ round-header
    const roundHeaders = document.querySelectorAll('.round-header');
    console.log('æ‰¾åˆ°çš„è½®æ¬¡å¤´éƒ¨æ•°é‡:', roundHeaders.length);

    if (roundHeaders.length === 0) {
        console.log('âŒ æœªæ‰¾åˆ°è½®æ¬¡å¤´éƒ¨');
        return;
    }

    // æ‰¾åˆ°å½“å‰è½®æ¬¡çš„ header
    let currentRoundHeader = null;
    for (let header of roundHeaders) {
        if (header.dataset.roundId === currentRoundId) {
            currentRoundHeader = header;
            console.log('âœ… æ‰¾åˆ°å½“å‰è½®æ¬¡å¤´éƒ¨');
            break;
        }
    }

    if (!currentRoundHeader) {
        console.log('âŒ æœªæ‰¾åˆ°åŒ¹é…çš„è½®æ¬¡å¤´éƒ¨');
        return;
    }

    // ä»è½®æ¬¡å¤´éƒ¨æ–‡æœ¬ä¸­æå–è½®æ¬¡ç´¢å¼•
    const roundText = currentRoundHeader.textContent.trim();
    const roundMatch = roundText.match(/ç¬¬(\d+)è½®/);
    let roundIndex = roundMatch ? parseInt(roundMatch[1]) - 1 : 0;
    console.log('è½®æ¬¡ç´¢å¼•:', roundIndex, 'è½®æ¬¡æ–‡æœ¬:', roundText);

    // åˆ›å»ºæŠ¥å‘ŠæŒ‰é’®HTML
    const reportButtonsHTML = `
        <div class="btn-group btn-group-sm" role="group">
            <button class="btn btn-outline-primary" onclick="generateRoundReport('${SESSION_ID}', ${roundIndex})" title="ç”Ÿæˆç¬¬${roundIndex + 1}è½®æŠ¥å‘Š">
                <i class="fas fa-magic me-1"></i>ç”ŸæˆæŠ¥å‘Š
            </button>
            <button class="btn btn-outline-success" onclick="viewRoundReport('${SESSION_ID}', ${roundIndex})" style="display: none;" id="viewReportBtn_${roundIndex}" title="æŸ¥çœ‹æŠ¥å‘Š">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-outline-info" onclick="downloadRoundReport('${SESSION_ID}', ${roundIndex})" style="display: none;" id="downloadReportBtn_${roundIndex}" title="ä¸‹è½½PDF">
                <i class="fas fa-download"></i>
            </button>
        </div>
    `;

    // æ·»åŠ åˆ°å¤´éƒ¨æŒ‰é’®å®¹å™¨
    const container = document.getElementById('reportButtonsContainer');
    if (container) {
        console.log('âœ… æ­£åœ¨æ·»åŠ æŠ¥å‘ŠæŒ‰é’®åˆ°å¤´éƒ¨...');
        container.innerHTML = reportButtonsHTML;
        YeyingInterviewer.showToast('success', 'æ‚¨ç°åœ¨å¯ä»¥ç”Ÿæˆæœ¬è½®é¢è¯•æŠ¥å‘Šäº†ï¼');
        console.log('âœ… æŠ¥å‘ŠæŒ‰é’®æ·»åŠ æˆåŠŸï¼');
    } else {
        console.log('âŒ æœªæ‰¾åˆ° reportButtonsContainer å…ƒç´ ');
    }
}

// ç”Ÿæˆè½®æ¬¡æŠ¥å‘Š
async function generateRoundReport(sessionId, roundIndex) {
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        YeyingInterviewer.showToast('info', 'æ­£åœ¨ç”Ÿæˆé¢è¯•æŠ¥å‘Šï¼Œè¯·ç¨å€™...');

        const response = await fetch(`/api/generate_report/${sessionId}/${roundIndex}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const data = await response.json();

        if (data.success) {
            YeyingInterviewer.showToast('success', 'é¢è¯•æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼');

            // æ˜¾ç¤ºæŸ¥çœ‹å’Œä¸‹è½½æŒ‰é’®
            const viewBtn = document.getElementById(`viewReportBtn_${roundIndex}`);
            const downloadBtn = document.getElementById(`downloadReportBtn_${roundIndex}`);

            if (viewBtn) viewBtn.style.display = 'inline-block';
            if (downloadBtn) downloadBtn.style.display = 'inline-block';

            // åœ¨èŠå¤©ä¸­æ·»åŠ æˆåŠŸæ¶ˆæ¯
            addMessage('ai', `ğŸ“Š ç¬¬${roundIndex + 1}è½®é¢è¯•æŠ¥å‘Šç”Ÿæˆå®Œæˆï¼æ‚¨å¯ä»¥ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æŸ¥çœ‹æˆ–ä¸‹è½½æŠ¥å‘Šã€‚`);

        } else {
            YeyingInterviewer.showToast('error', data.error || data.message || 'ç”ŸæˆæŠ¥å‘Šå¤±è´¥');
        }

    } catch (error) {
        console.error('ç”ŸæˆæŠ¥å‘Šå¤±è´¥:', error);
        YeyingInterviewer.showToast('error', 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
    }
}

// æŸ¥çœ‹è½®æ¬¡æŠ¥å‘Š
async function viewRoundReport(sessionId, roundIndex) {
    try {
        const response = await fetch(`/api/reports/${sessionId}/${roundIndex}`);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();

        if (data.success && data.data && data.data.evaluation_data) {
            // æ˜¾ç¤ºæŠ¥å‘Šè¯¦æƒ…æ¨¡æ€æ¡†
            showReportModal(data.data.evaluation_data);
        } else {
            YeyingInterviewer.showToast('error', data.error || data.message || 'è·å–æŠ¥å‘Šå¤±è´¥');
        }

    } catch (error) {
        console.error('è·å–æŠ¥å‘Šå¤±è´¥:', error);
        YeyingInterviewer.showToast('error', 'ç½‘ç»œè¯·æ±‚å¤±è´¥');
    }
}

// ä¸‹è½½è½®æ¬¡æŠ¥å‘ŠPDF
async function downloadRoundReport(sessionId, roundIndex) {
    try {
        const downloadUrl = `/api/reports/download/${sessionId}/${roundIndex}`;

        // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ä¸‹è½½é“¾æ¥
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = `interview_report_${sessionId}_${roundIndex}.pdf`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        YeyingInterviewer.showToast('success', 'PDFæŠ¥å‘Šä¸‹è½½å¼€å§‹');

    } catch (error) {
        console.error('ä¸‹è½½æŠ¥å‘Šå¤±è´¥:', error);
        YeyingInterviewer.showToast('error', 'ä¸‹è½½å¤±è´¥');
    }
}

// æ˜¾ç¤ºæŠ¥å‘Šè¯¦æƒ…æ¨¡æ€æ¡†
function showReportModal(reportData) {
    if (!reportData) {
        YeyingInterviewer.showToast('error', 'æŠ¥å‘Šæ•°æ®æ— æ•ˆ');
        return;
    }

    const header = reportData.report_header || {};
    const interviewerComment = reportData.interviewer_comment || {};
    const comprehensiveAnalysis = reportData.comprehensive_analysis || {};
    const sessionInfo = reportData.session_info || {};

    const modalHTML = `
        <div class="modal fade" id="reportModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-file-alt me-2"></i>${header.report_title || 'é¢è¯•æŠ¥å‘Š'}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <!-- æŠ¥å‘Šå¤´éƒ¨ä¿¡æ¯ -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h2 class="text-primary mb-1">${header.overall_grade || 'N/A'}</h2>
                                        <p class="text-muted mb-0">ç»¼åˆç­‰çº§</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <h2 class="text-success mb-1">${header.total_score !== undefined ? header.total_score + 'åˆ†' : 'N/A'}</h2>
                                        <p class="text-muted mb-0">ç»¼åˆå¾—åˆ†</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- é¢è¯•å®˜è¯„ä»· -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-user-tie me-2"></i>é¢è¯•å®˜ç‚¹è¯„</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>æ€»ä½“è¯„ä»·ï¼š</strong></p>
                                <p class="text-muted">${interviewerComment.summary || 'æš‚æ— è¯„ä»·'}</p>
                                <p><strong>æ”¹è¿›å»ºè®®ï¼š</strong></p>
                                <p class="text-muted">${interviewerComment.suggestions || 'æš‚æ— å»ºè®®'}</p>
                            </div>
                        </div>

                        <!-- ç»¼åˆåˆ†æ -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>ç»¼åˆåˆ†æ</h6>
                            </div>
                            <div class="card-body">
                                ${Object.entries(comprehensiveAnalysis).map(([key, item]) => `
                                    <div class="row mb-2">
                                        <div class="col-4">${getAnalysisLabel(key)}:</div>
                                        <div class="col-2">
                                            <span class="badge bg-${getScoreBadgeColor(item.score || 0)}">${item.score || 0}åˆ†</span>
                                        </div>
                                        <div class="col-6 text-muted small">${item.comment || ''}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                        <button type="button" class="btn btn-primary" onclick="downloadRoundReport('${sessionInfo.session_id || SESSION_ID}', ${sessionInfo.round_index !== undefined ? sessionInfo.round_index : 0})">
                            <i class="fas fa-download me-1"></i>ä¸‹è½½PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;

    // ç§»é™¤å·²å­˜åœ¨çš„æ¨¡æ€æ¡†
    const existingModal = document.getElementById('reportModal');
    if (existingModal) {
        existingModal.remove();
    }

    // æ·»åŠ æ–°çš„æ¨¡æ€æ¡†
    document.body.insertAdjacentHTML('beforeend', modalHTML);

    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    const modal = new bootstrap.Modal(document.getElementById('reportModal'));
    modal.show();
}

// è·å–åˆ†æé¡¹ç›®æ ‡ç­¾
function getAnalysisLabel(key) {
    const labels = {
        'content_completeness': 'å†…å®¹å®Œæ•´åº¦',
        'highlight_prominence': 'äº®ç‚¹çªå‡ºåº¦',
        'logical_clarity': 'é€»è¾‘æ¸…æ™°åº¦',
        'expression_ability': 'è¡¨è¾¾èƒ½åŠ›',
        'position_matching': 'å²—ä½å¥‘åˆåº¦'
    };
    return labels[key] || key;
}

// è·å–åˆ†æ•°å¯¹åº”çš„badgeé¢œè‰²
function getScoreBadgeColor(score) {
    if (score >= 8) return 'success';
    if (score >= 6) return 'warning';
    return 'danger';
}

// æ£€æŸ¥å·²æœ‰æŠ¥å‘ŠçŠ¶æ€
async function checkExistingReports() {
    try {
        const response = await fetch(`/api/reports/list/${SESSION_ID}`);

        if (!response.ok) {
            console.warn(`Failed to fetch reports list: HTTP ${response.status}`);
            return;
        }

        const data = await response.json();

        if (data.success && data.data && data.data.reports) {
            data.data.reports.forEach(report => {
                if (report.evaluation_exists || report.pdf_exists) {
                    const viewBtn = document.getElementById(`viewReportBtn_${report.round_index}`);
                    const downloadBtn = document.getElementById(`downloadReportBtn_${report.round_index}`);

                    if (viewBtn && report.evaluation_exists) {
                        viewBtn.style.display = 'inline-block';
                    }
                    if (downloadBtn && report.pdf_exists) {
                        downloadBtn.style.display = 'inline-block';
                    }
                }
            });
        } else if (!data.success) {
            console.warn('Failed to load existing reports:', data.error || data.message);
        }
    } catch (error) {
        console.error('æ£€æŸ¥æŠ¥å‘ŠçŠ¶æ€å¤±è´¥:', error);
    }
}
</script>
{% endblock %}
