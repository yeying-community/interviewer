{% extends "base.html" %}

{% block title %}{{ session.name }} - é¢è¯•ä¼šè¯{% endblock %}

{% block extra_css %}
<style>
    .candidate-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
    }
    
    .interview-container {
        height: calc(100vh - 200px);
        display: flex;
        gap: 1rem;
    }
    
    .sidebar {
        width: 350px;
        max-height: 100%;
        overflow-y: auto;
    }
    
    .chat-area {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    @media (max-width: 992px) {
        .interview-container {
            flex-direction: column;
            height: auto;
        }
        
        .sidebar {
            width: 100%;
            max-height: 300px;
        }
        
        .chat-area {
            height: calc(100vh - 350px);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- é¢åŒ…å±‘å¯¼èˆª -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('main.index') }}">
                        <i class="fas fa-home me-1"></i>é¦–é¡µ
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{{ url_for('main.room_detail', room_id=session.room_id) }}">
                        <i class="fas fa-door-open me-1"></i>é¢è¯•é—´
                    </a>
                </li>
                <li class="breadcrumb-item active">
                    <i class="fas fa-comments me-1"></i>{{ session.name }}
                </li>
            </ol>
        </nav>
        
        <!-- ä¸»è¦é¢è¯•ç•Œé¢ -->
        <div class="interview-container">
            <!-- å·¦ä¾§è¾¹æ ï¼šå€™é€‰äººä¿¡æ¯å’Œç®€å† -->
            <div class="sidebar">
                {% if resume %}
                <!-- å€™é€‰äººåŸºæœ¬ä¿¡æ¯ -->
                <div class="candidate-info">
                    <div class="text-center mb-3">
                        <div class="candidate-avatar mb-2">
                            <i class="fas fa-user-circle fa-3x"></i>
                        </div>
                        <h5 class="mb-1">{{ resume.name }}</h5>
                        <p class="mb-0 opacity-75">{{ resume.position }}</p>
                    </div>
                    
                    <div class="candidate-stats">
                        <div class="row text-center">
                            <div class="col-6">
                                <div class="border-end border-light border-opacity-50">
                                    <h6 class="mb-0">{{ resume.skills|length }}</h6>
                                    <small class="opacity-75">æŠ€èƒ½é¡¹ç›®</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <h6 class="mb-0">{{ resume.projects|length }}</h6>
                                <small class="opacity-75">é¡¹ç›®ç»éªŒ</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- æŠ€èƒ½åˆ—è¡¨ -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>æŠ€èƒ½æ ˆ
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        <div class="skill-tags">
                            {% for skill in resume.skills %}
                            <div class="skill-item mb-2 p-2 border rounded">
                                <small class="text-muted">{{ loop.index }}.</small>
                                <span class="ms-1" style="font-size: 0.85rem;">{{ skill[:80] }}{% if skill|length > 80 %}...{% endif %}</span>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                
                <!-- é¡¹ç›®ç»éªŒ -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>é¡¹ç›®ç»éªŒ
                        </h6>
                    </div>
                    <div class="card-body p-2">
                        {% for project in resume.projects %}
                        <div class="project-item mb-2 p-2 border rounded">
                            <div class="d-flex align-items-start">
                                <i class="fas fa-code text-primary me-2 mt-1"></i>
                                <div class="flex-grow-1">
                                    <small class="text-muted">é¡¹ç›® {{ loop.index }}</small>
                                    <div style="font-size: 0.85rem;" class="mt-1">
                                        {{ project[:100] }}{% if project|length > 100 %}...{% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            
            <!-- å³ä¾§ï¼šChatGPTé£æ ¼å¯¹è¯ç•Œé¢ -->
            <div class="chat-area">
                <div class="chat-container">
                    <!-- èŠå¤©å¤´éƒ¨ -->
                    <div class="chat-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">{{ session.name }}</h6>
                                <small class="opacity-75">AIæ™ºèƒ½é¢è¯•å®˜</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-light" onclick="generateQuestions()">
                                    <i class="fas fa-plus me-1"></i>ç”Ÿæˆé¢è¯•é¢˜
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ¶ˆæ¯åŒºåŸŸ -->
                    <div class="chat-messages" id="chatMessages">
                        <!-- æ¬¢è¿æ¶ˆæ¯ -->
                        <div class="message ai">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div>æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„AIé¢è¯•å®˜ã€‚æˆ‘å·²ç»æŸ¥çœ‹äº†æ‚¨çš„ç®€å†ï¼Œå‡†å¤‡å¼€å§‹é¢è¯•ã€‚</div>
                                <div class="message-time">{{ session.created_at[:19]|replace('T', ' ') }}</div>
                            </div>
                        </div>
                        
                        <!-- åŠ¨æ€åŠ è½½çš„å¯¹è¯è½®æ¬¡ -->
                        {% for round in rounds %}
                        <div class="round-header">
                            <span>ç¬¬{{ round.round_index + 1 }}è½®é¢è¯•é¢˜</span>
                        </div>
                        
                        <!-- AIç”Ÿæˆçš„é—®é¢˜ -->
                        <div class="message ai">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <div>æˆ‘ä¸ºæ‚¨å‡†å¤‡äº†ä»¥ä¸‹{{ round.questions|length }}é“é¢è¯•é¢˜ï¼š</div>
                                <div class="questions-container mt-3">
                                    {% for question in round.questions %}
                                    <div class="question-card mb-2">
                                        <div class="question-text">
                                            <span class="question-number">{{ loop.index }}.</span>
                                            {{ question }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                                <div class="message-time">{{ round.created_at[:19]|replace('T', ' ') }}</div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                        <div class="typing-indicator" id="typingIndicator" style="display: none;">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div>
                                AIæ­£åœ¨ç”Ÿæˆé¢è¯•é¢˜
                                <div class="typing-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- è¾“å…¥åŒºåŸŸ -->
                    <div class="chat-input">
                        <div class="input-group">
                            <input type="text" 
                                   class="form-control" 
                                   placeholder="æ‚¨å¯ä»¥å›ç­”é¢è¯•é¢˜æˆ–è¯·æ±‚ç”Ÿæˆæ–°çš„é¢˜ç›®..." 
                                   id="messageInput"
                                   onkeypress="handleKeyPress(event)">
                            <button class="btn btn-primary" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        
                        <div class="mt-2 text-center">
                            <small class="text-muted">
                                æŒ‰å›è½¦å‘é€æ¶ˆæ¯ | 
                                <a href="javascript:generateQuestions()" class="text-decoration-none">ç‚¹å‡»ç”Ÿæˆæ–°çš„é¢è¯•é¢˜</a>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// å…¨å±€ä¼šè¯IDå’Œå½“å‰è½®æ¬¡çŠ¶æ€
const SESSION_ID = '{{ session.id }}';
let currentRoundId = null;
let currentQuestionData = null;

// é¡µé¢åŠ è½½å®Œæˆåæ»šåŠ¨åˆ°åº•éƒ¨
$(document).ready(function() {
    scrollToBottom();
    console.log('é¢è¯•ä¼šè¯é¡µé¢å·²åŠ è½½');

    // æ£€æŸ¥æ˜¯å¦æœ‰è¿›è¡Œä¸­çš„è½®æ¬¡
    checkActiveRound();
});

// æ£€æŸ¥æ˜¯å¦æœ‰è¿›è¡Œä¸­çš„è½®æ¬¡
async function checkActiveRound() {
    // æŸ¥æ‰¾é¡µé¢ä¸­çš„æœ€åä¸€ä¸ªè½®æ¬¡
    const rounds = document.querySelectorAll('.round-header');
    if (rounds.length > 0) {
        // ä»æœ€åä¸€ä¸ªè½®æ¬¡headeræå–round_id
        const lastRound = rounds[rounds.length - 1];
        const roundData = lastRound.dataset.roundId;
        if (roundData) {
            currentRoundId = roundData;
            // å°è¯•åŠ è½½å½“å‰é—®é¢˜
            await loadCurrentQuestion();
        }
    }
}

// æ»šåŠ¨åˆ°æ¶ˆæ¯åº•éƒ¨
function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// å¤„ç†é”®ç›˜æŒ‰é”®
function handleKeyPress(event) {
    if (event.key === 'Enter') {
        sendMessage();
    }
}

// å‘é€æ¶ˆæ¯ï¼ˆå¤„ç†ç”¨æˆ·å›ç­”ï¼‰
function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();

    if (message && currentQuestionData) {
        // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
        addMessage('user', message);
        input.value = '';

        // ä¿å­˜å›ç­”åˆ°åç«¯
        saveAnswer(currentQuestionData.qa_id, message);
    } else if (message && !currentQuestionData) {
        // æ²¡æœ‰å½“å‰é—®é¢˜æ—¶çš„æ™®é€šèŠå¤©
        addMessage('user', message);
        input.value = '';

        // æ¨¡æ‹ŸAIå›å¤
        setTimeout(() => {
            addMessage('ai', 'æ„Ÿè°¢æ‚¨çš„å›ç­”ã€‚å¦‚æœæ‚¨å‡†å¤‡å¥½äº†ï¼Œå¯ä»¥ç‚¹å‡»"ç”Ÿæˆé¢è¯•é¢˜"å¼€å§‹é¢è¯•ã€‚');
        }, 1000);
    }
}

// æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒºåŸŸ
function addMessage(type, content) {
    const chatMessages = document.getElementById('chatMessages');
    const messageTime = new Date().toLocaleString('zh-CN');
    
    const messageHTML = `
        <div class="message ${type}">
            <div class="message-avatar">
                <i class="fas fa-${type === 'user' ? 'user' : 'robot'}"></i>
            </div>
            <div class="message-content">
                <div>${content}</div>
                <div class="message-time">${messageTime}</div>
            </div>
        </div>
    `;
    
    chatMessages.insertAdjacentHTML('beforeend', messageHTML);
    scrollToBottom();
}

// ç”Ÿæˆé¢è¯•é¢˜
async function generateQuestions() {
    // æŸ¥æ‰¾æ‰€æœ‰ç”ŸæˆæŒ‰é’®ï¼Œä¼˜å…ˆä½¿ç”¨headerä¸­çš„æŒ‰é’®
    const headerButton = document.querySelector('.chat-header button');
    const button = headerButton || (event && event.target && event.target.closest('button'));
    
    let originalContent = '';
    if (button) {
        originalContent = button.innerHTML;
    }
    
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        if (button) {
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ç”Ÿæˆä¸­...';
            button.disabled = true;
        }
        
        // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨
        document.getElementById('typingIndicator').style.display = 'flex';
        scrollToBottom();
        
        // è°ƒç”¨APIç”Ÿæˆé—®é¢˜
        const response = await fetch(`/generate_questions/${SESSION_ID}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        // éšè—åŠ è½½æŒ‡ç¤ºå™¨
        document.getElementById('typingIndicator').style.display = 'none';
        
        if (data.success) {
            // è®¾ç½®å½“å‰è½®æ¬¡ID
            currentRoundId = data.round_id;

            // æ·»åŠ è½®æ¬¡æ ‡é¢˜
            const roundHeader = `
                <div class="round-header" data-round-id="${data.round_id}">
                    <span>ç¬¬${data.round_index + 1}è½®é¢è¯•é¢˜</span>
                </div>
            `;
            document.getElementById('chatMessages').insertAdjacentHTML('beforeend', roundHeader);

            // æ˜¾ç¤ºå¼€å§‹æ¶ˆæ¯
            addMessage('ai', `å¥½çš„ï¼æˆ‘ä¸ºæ‚¨å‡†å¤‡äº†${data.questions.length}é“é¢è¯•é¢˜ã€‚è®©æˆ‘ä»¬é€ä¸€è¿›è¡Œï¼Œè¯·ä»”ç»†å›ç­”æ¯ä¸€é“é¢˜ç›®ã€‚`);

            YeyingInterviewer.showToast('success', `æˆåŠŸç”Ÿæˆ${data.questions.length}é“é¢è¯•é¢˜`);

            // åŠ è½½ç¬¬ä¸€ä¸ªé—®é¢˜
            await loadCurrentQuestion();
        } else {
            YeyingInterviewer.showToast('error', data.error || 'ç”Ÿæˆé¢è¯•é¢˜å¤±è´¥');
        }
        
    } catch (error) {
        console.error('ç”Ÿæˆé¢è¯•é¢˜å¤±è´¥:', error);
        YeyingInterviewer.showToast('error', 'ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
        document.getElementById('typingIndicator').style.display = 'none';
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        if (button && originalContent) {
            button.innerHTML = originalContent;
            button.disabled = false;
        }
    }
}

// åŠ è½½å½“å‰é—®é¢˜
async function loadCurrentQuestion() {
    if (!currentRoundId) return;

    try {
        const response = await fetch(`/get_current_question/${currentRoundId}`);
        const data = await response.json();

        if (data.success && data.question_data) {
            currentQuestionData = data.question_data;

            // æ˜¾ç¤ºå½“å‰é—®é¢˜
            const questionHTML = `
                <div class="current-question-info mb-2">
                    <small class="text-muted">ã€${data.question_data.category}ã€‘é—®é¢˜ ${data.question_data.question_number}/${data.question_data.total_questions}</small>
                </div>
                <div class="question-text">${data.question_data.question}</div>
                <div class="mt-2">
                    <small class="text-info">è¯·åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­å›ç­”è¿™ä¸ªé—®é¢˜...</small>
                </div>
            `;

            addMessage('ai', questionHTML);

            // æ›´æ–°è¾“å…¥æ¡†æç¤º
            const input = document.getElementById('messageInput');
            input.placeholder = `è¯·å›ç­”ç¬¬${data.question_data.question_number}é¢˜...`;
            input.focus();

        } else {
            // æ²¡æœ‰æ›´å¤šé—®é¢˜äº†
            currentQuestionData = null;
            addMessage('ai', 'ğŸ‰ æ­å–œï¼æ‚¨å·²ç»å®Œæˆäº†æœ¬è½®æ‰€æœ‰é¢è¯•é¢˜ã€‚æ‚¨å¯ä»¥ç”Ÿæˆæ–°çš„ä¸€è½®é¢è¯•é¢˜ç»§ç»­ç»ƒä¹ ã€‚');

            // æ¢å¤è¾“å…¥æ¡†æç¤º
            const input = document.getElementById('messageInput');
            input.placeholder = 'æ‚¨å¯ä»¥å›ç­”é¢è¯•é¢˜æˆ–è¯·æ±‚ç”Ÿæˆæ–°çš„é¢˜ç›®...';
        }

    } catch (error) {
        console.error('åŠ è½½é—®é¢˜å¤±è´¥:', error);
        YeyingInterviewer.showToast('error', 'åŠ è½½é—®é¢˜å¤±è´¥');
    }
}

// ä¿å­˜ç”¨æˆ·å›ç­”
async function saveAnswer(qaId, answerText) {
    try {
        const response = await fetch('/save_answer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                qa_id: qaId,
                answer_text: answerText
            })
        });

        const data = await response.json();

        if (data.success) {
            // æ˜¾ç¤ºç¡®è®¤æ¶ˆæ¯
            setTimeout(() => {
                if (data.is_round_completed) {
                    addMessage('ai', 'âœ… å›ç­”å·²ä¿å­˜ï¼ğŸ‰ æ‚¨å·²å®Œæˆæœ¬è½®æ‰€æœ‰é¢è¯•é¢˜ï¼Œè¡¨ç°å‡ºè‰²ï¼');
                    currentQuestionData = null;

                    // æ¢å¤è¾“å…¥æ¡†æç¤º
                    const input = document.getElementById('messageInput');
                    input.placeholder = 'æ‚¨å¯ä»¥å›ç­”é¢è¯•é¢˜æˆ–è¯·æ±‚ç”Ÿæˆæ–°çš„é¢˜ç›®...';
                } else {
                    addMessage('ai', `âœ… å›ç­”å·²ä¿å­˜ï¼è¿˜æœ‰ ${data.remaining_questions} é“é¢˜ï¼Œè®©æˆ‘ä»¬ç»§ç»­ä¸‹ä¸€é¢˜ã€‚`);
                    // åŠ è½½ä¸‹ä¸€ä¸ªé—®é¢˜
                    setTimeout(() => loadCurrentQuestion(), 1000);
                }
            }, 500);

        } else {
            YeyingInterviewer.showToast('error', data.error || 'ä¿å­˜å›ç­”å¤±è´¥');
        }

    } catch (error) {
        console.error('ä¿å­˜å›ç­”å¤±è´¥:', error);
        YeyingInterviewer.showToast('error', 'ä¿å­˜å›ç­”å¤±è´¥');
    }
}

// é¡µé¢å¸è½½æ—¶çš„æ¸…ç†
$(window).on('beforeunload', function() {
    console.log('é¢è¯•ä¼šè¯é¡µé¢å³å°†å¸è½½');
});
</script>
{% endblock %}